{% extends "base.html" %}
{% load static %}

{% block title %}Checkout - STORE{% endblock %}

{% block content %}
<main>
  <div class="container">

    <!-- BREADCRUMB -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
      <a href="{% url 'home' %}">Início</a>
      <span class="breadcrumb-sep">/</span>
      <a href="{% url 'cart_detail' %}">Carrinho</a>
      <span class="breadcrumb-sep">/</span>
      <span>Checkout</span>
    </nav>

    <div class="page-title">
      <h1>Finalizar Compra</h1>
      <p>Revise seu pedido e selecione o endereço de entrega</p>
    </div>

    <div class="checkout-layout">

      <!-- CHECKOUT FORM -->
      <form action="{% url 'checkout_confirm' %}" method="post">
        {% csrf_token %}

        <div>

          <!-- ADDRESS SELECTION -->
          <div class="checkout-section">
            <h3>Endereço de Entrega</h3>

            {% if addresses %}
              {% for addr in addresses %}
                <div class="address-option {% if addr.id == selected_address_id or addr.is_default %}selected{% endif %}">
                  <input
                    type="radio"
                    name="address_id"
                    id="addr{{ addr.id }}"
                    value="{{ addr.id }}"
                    {% if addr.id == selected_address_id or addr.is_default %}checked{% endif %}
                    required
                  >

                  <label for="addr{{ addr.id }}" class="address-option-text">
                    <strong>{{ addr.label|default:"Endereço" }}</strong><br>
                    {{ addr.street }}, {{ addr.number }}{% if addr.complement %} - {{ addr.complement }}{% endif %}<br>
                    {{ addr.district }} - {{ addr.city }}, {{ addr.state }}<br>
                    CEP: {{ addr.cep }}
                  </label>
                </div>
              {% endfor %}
            {% else %}
              <p>Você ainda não possui endereços cadastrados.</p>
            {% endif %}

            <a href="{% url 'address_create' %}" class="btn btn-outline btn-sm mt-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor"
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14"/><path d="M12 5v14"/>
              </svg>
              Novo Endereço
            </a>
          </div>

          <!-- ORDER ITEMS -->
          <div class="checkout-section">
            <h3>Itens do Pedido</h3>

            <table class="order-items-table">
              <thead>
                <tr>
                  <th>Produto</th>
                  <th>Qtd</th>
                  <th>Preço</th>
                  <th>Subtotal</th>
                </tr>
              </thead>

              <tbody>
                {% for item in summary.items %}
                  <tr>
                    <td>
                      <div class="cart-item-info">
                        {% if item.image_url %}
                          <img src="{{ item.image_url }}" alt="{{ item.name }}"
                               class="cart-item-img" style="width:48px;height:48px;">
                        {% else %}
                          <img src="{% static 'img/placeholder.jpg' %}" alt="{{ item.name }}"
                               class="cart-item-img" style="width:48px;height:48px;">
                        {% endif %}

                        <div>
                          <div class="cart-item-name">{{ item.name }}</div>
                        </div>
                      </div>
                    </td>

                    <td>{{ item.quantity }}</td>
                    <td>R$ {{ item.unit_price }}</td>
                    <td class="fw-semibold">R$ {{ item.subtotal }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>

        <!-- ORDER SUMMARY -->
        <aside class="cart-summary">
          <h3>Resumo do Pedido</h3>

          <div class="summary-row">
            <span>Subtotal ({{ summary.items|length }} item{{ summary.items|length|pluralize:",s" }})</span>
            <span>R$ {{ summary.total }}</span>
          </div>

          <div class="summary-row">
            <span>Frete</span>
            <span class="text-success">Grátis</span>
          </div>

          <div class="summary-row total">
            <span>Total</span>
            <span>R$ {{ summary.total }}</span>
          </div>

          <button type="submit" class="btn btn-accent btn-block btn-lg mt-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
              <path d="m9 12 2 2 4-4"/>
            </svg>
            Confirmar Pedido
          </button>

          <a href="{% url 'cart_detail' %}" class="btn btn-outline btn-block btn-sm mt-1">
            Voltar ao Carrinho
          </a>
        </aside>

      </form>

    </div>
  </div>
</main>
{% endblock %}
