{% extends "base.html" %}
{% load static %}

{% block title %}Carrinho - STORE{% endblock %}

{% block content %}
<main>
  <div class="container">
    <!-- BREADCRUMB -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
      <a href="{% url 'home' %}">Início</a>
      <span class="breadcrumb-sep">/</span>
      <span>Carrinho</span>
    </nav>

    <div class="page-title">
      <h1>Seu Carrinho</h1>
      <p>
        {{ summary.items|length }} item{{ summary.items|length|pluralize:",s" }} no carrinho
      </p>
    </div>

    {% if summary.items %}
      <div class="cart-layout">

        <!-- CART ITEMS -->
        <div>
          <table class="cart-table">
            <thead>
              <tr>
                <th>Produto</th>
                <th>Preço</th>
                <th>Quantidade</th>
                <th>Subtotal</th>
                <th></th>
              </tr>
            </thead>

            <tbody>
              {% for item in summary.items %}
                <tr>
                  <td>
                    <div class="cart-item-info">
                      {% comment %}
                        Fallback de imagem:
                        - se item.image_url existir (por ex. vindo do service), usa.
                        - senão, usa placeholder local.
                      {% endcomment %}
                      {% if item.image_url %}
                        <img src="{{ item.image_url }}" alt="{{ item.name }}" class="cart-item-img">
                      {% else %}
                        <img src="{% static 'img/placeholder.jpg' %}" alt="{{ item.name }}" class="cart-item-img">
                      {% endif %}

                      <div>
                        <div class="cart-item-name">
                          {% if item.slug %}
                            <a href="{% url 'product_detail' slug=item.slug %}">{{ item.name }}</a>
                          {% else %}
                            {{ item.name }}
                          {% endif %}
                        </div>

                        {% if item.category %}
                          <div class="cart-item-category">{{ item.category }}</div>
                        {% endif %}
                      </div>
                    </div>
                  </td>

                  <td class="cart-item-price">R$ {{ item.unit_price }}</td>

                  <td class="cart-item-qty">
                    <form action="{% url 'cart_update' item_id=item.cart_item_id %}" method="post">
                      {% csrf_token %}
                      <input
                        type="number"
                        name="quantity"
                        value="{{ item.quantity }}"
                        min="0"
                      >
                      <button type="submit" class="btn btn-outline btn-sm" style="margin-left: 6px;">
                        Atualizar
                      </button>
                    </form>
                  </td>

                  <td class="cart-item-price">R$ {{ item.subtotal }}</td>

                  <td>
                    <form action="{% url 'cart_remove' item_id=item.cart_item_id %}" method="post">
                      {% csrf_token %}
                      <button class="cart-item-remove" aria-label="Remover item" title="Remover" type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                             viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        </svg>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="mt-3">
            <a href="{% url 'home' %}" class="btn btn-outline">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor"
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m12 19-7-7 7-7"/><path d="M19 12H5"/>
              </svg>
              Continuar Comprando
            </a>
          </div>
        </div>

        <!-- CART SUMMARY -->
        <aside class="cart-summary">
          <h3>Resumo do Pedido</h3>

          <div class="summary-row">
            <span>Subtotal ({{ summary.items|length }} item{{ summary.items|length|pluralize:",s" }})</span>
            <span>R$ {{ summary.total }}</span>
          </div>

          <div class="summary-row">
            <span>Frete</span>
            <span class="text-success">Grátis</span>
          </div>

          <div class="summary-row total">
            <span>Total</span>
            <span>R$ {{ summary.total }}</span>
          </div>

          <a href="{% url 'checkout' %}" class="btn btn-accent btn-block btn-lg">
            Finalizar Compra
          </a>
        </aside>

      </div>

    {% else %}
      <p>Seu carrinho está vazio.</p>
      <p><a href="{% url 'home' %}" class="btn btn-outline">Voltar para a loja</a></p>
    {% endif %}

  </div>
</main>
{% endblock %}
